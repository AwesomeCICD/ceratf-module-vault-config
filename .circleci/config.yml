version: 2.1
orbs:
  terraform: circleci/terraform@3.2.1
  semver: cci-labs/semver@dev:1

jobs:
  tf-validate:
    executor: terraform/default
    steps:
      - terraform/fmt
      - terraform/validate

workflows:
  main:
    jobs:
      - tf-validate:
          name: Validate Terraform Plan
      - semver/bump:
          pre-steps: 
            - checkout
            - run:
                name: Set current and bump level
                command: |
                  # grab latest tag from git as current
                  echo "export CURRENT_VERSION=$(git tag -i | tail -1)" >> $BASH_ENV
                  # parse for bump level in commit message
                  echo "export SEMVER_INCREMENT=$(git log -1 --pretty=%B | sed -En 's/.*\[semver: ?(major|minor|patch|skip)\].*/\1/pi' | tr '[:upper:]' '[:lower:]') >> $BASH_ENV
          post-steps: 
            - run: 
                name: Use new version values
                command: |
                  git tag ${MAJOR}.${MINOR}.${PATCH}
                  #git push --tags
          requires: [Validate Terraform Plan]
          # filters:
          #   branches:
          #     only: [main]

# VS Code Extension Version: 1.4.0